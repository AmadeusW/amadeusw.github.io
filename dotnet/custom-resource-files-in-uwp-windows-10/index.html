<!doctype html><html><head><title>Amadeus' page</title><link rel=stylesheet href=//amadeusw.com/css/style.css></head><body><div id=container class=centered><header id=title class="containerelement navcontent"><a class=link href=//amadeusw.com><span class=headercontent>Amadeo</span></a></header><div id=subtitle class="accent_dotnet containerelement navcontent"><span class=headercontent>Custom resource files in UWP</span></div><nav class="accent_dotnet containerelement"><div class=navcontent><a class=link href=/travel/>Travel</a>
<a class=link href=/3dprinting/>3D printing</a>
<a class=link href=/tech/>Electronics</a>
<a class=link href=/projects/>Projects</a>
<a class=link href=/cookery/>Cookery</a>
<a class="link active" href=/dotnet/>.net</a></div></nav><div id=content class=containerelement><main class=centered><article class=dotnet><p>I made a rookie mistake of hardcoding the weather service API token (key) into a public github repo, and did it all live on camera when recording an episode of <a href="https://www.youtube.com/watch?v=NCMQIH0ilLo">Coding with Amadeus: Smart Mirror</a>. I should have stored the token in an untracked resource file, but it&rsquo;s done differently in the Universal Windows Platform. In this blog post we will explore two ways of accessing data from files in UWP apps.</p><h1 id=protect-the-api-token>Protect the API token</h1><p>When an API token is leaked, you need to invalidate it. Ensure that a new token won&rsquo;t be leaked again then get a new token:</p><ol><li>Reset the API token</li></ol><ul><li>Ideally, the service provider offers a way to reset the API token. The old token becomes invalid, and you get a new one.</li><li>In another case, you need to create a new account and use its API token.</li></ul><ol start=2><li>Remove the token from the source code</li></ol><ul><li><a href=https://www.atlassian.com/git/tutorials/rewriting-history/git-reflog>Rewriting git history</a> is possible, but not recommended - especially if you pushed your changes and others might have pulled them.</li><li>Replace the API token string literal with code that accesses the resources (the subject of this blog post)</li></ul><ol start=3><li>Create a resource file that will hold sensitive data</li></ol><ul><li>Commit this (empty) file to avoid <code>FileNotFoundException</code> and other issues</li></ul><ol start=4><li>Cease tracking the resource file. See <a href=https://stackoverflow.com/questions/8309304/what-is-best-practice-for-keeping-secrets-out-of-a-git-repository>StackOverflow on What is best practice for keeping secrets out of a git repository?</a> for a basic and robust approach or tl;dr the basic approach:</li></ol><ul><li><code>git update-index --skip-worktree secretFile.txt</code></li><li>Now you can write your API tokens into the file, and git won&rsquo;t pick up these changes</li><li>Make sure to supply required tokens to continuous integration and build server</li></ul><h1 id=background-sensitive-data-in-aspmvc>Background: sensitive data in ASP.MVC</h1><p>To provide some background, I stored the secret token in git-ignored <code>Sensitive.config</code> file (<a href=https://github.com/CodeConnect/SourceBrowser/blob/9848ba033619d9887e1c358bc721284c29ebe8e2/src/Security.config>see the file on GitHub</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;appSettings&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>key=</span><span style=color:#e6db74>&#34;secret&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/appSettings&gt;</span>
</span></span></code></pre></div><p>Which I then merged into <code>Web.config</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;appSettings</span> <span style=color:#a6e22e>file=</span><span style=color:#e6db74>&#34;Sensitive.config&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>key=</span><span style=color:#e6db74>&#34;public&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;sample text&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/appSettings&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>I could then easily access the data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> secret = ConfigurationManager.AppSettings[<span style=color:#e6db74>&#34;secret&#34;</span>];
</span></span></code></pre></div><p>On my dev machine, CI server and production server, we had a version of <code>Sensitive.config</code> that set the <code>secret</code> key. Everyone else is encouraged to use their own API token or face limited functionality.</p><h1 id=state-of-things-in-uwp>State of things in UWP</h1><p>Universal apps run in a sandboxed UWP runtime and use a subset of the .NET framework.</p><p>On UWP, we have no access to <a href="https://msdn.microsoft.com/en-us/library/system.configuration.configurationmanager%28v=vs.110%29.aspx">System.Configuration.ConfigurationManager</a>, but we get limited access to filesystem using APIs shared across all platforms (Desktop, Mobile, IoT etc.)</p><p>In brief, access to the filesystem in UWP is limited to the <a href=https://msdn.microsoft.com/en-us/library/windows/apps/windows.storage.downloadsfolder.aspx>DownloadsFolder</a>, <a href=https://msdn.microsoft.com/library/windows/apps/windows.storage.knownfolders.aspx>KnownFolders</a> (user&rsquo;s libraries such as photos, music, videos etc) and <a href=https://msdn.microsoft.com/en-us/library/windows/apps/windows.storage.applicationdata.localfolder.aspx>ApplicationData.LocalFolder</a></p><p>Microsoft provides a very good guide on how to <a href=https://msdn.microsoft.com/en-us/library/windows/apps/mt299098.aspx>Store and retrieve settings and other app data</a>, which are loaded from the <code>LocalFolder</code>. Unfortunately, these settings need to be programatically created from within the app, for example on first launch. My IoT project doesn&rsquo;t have keyboard input so I can&rsquo;t rely on saving an API token typed in by the user. <strong>In my use case, I must hide the data from source control</strong>, so I need to store it in an untracked resource or configuration file.</p><h1 id=uwp-read-any-file-bundled-with-the-application>UWP: Read any file bundled with the application</h1><p>The good news is that UWP provides access to more than user&rsquo;s Documents. We have access to application&rsquo;s storage locker as well as read-only access to the directory where the application&rsquo;s <code>.exe</code> is located.</p><p>To access files located where <code>.exe</code> is, we just need to set the file&rsquo;s <strong>Build Action</strong> to <code>Content</code>. <strong>Copy to Output Directory</strong> doesn&rsquo;t matter.</p><p><img src=//amadeusw.com/techBlogData//custom-resource-files-in-uwp-windows-10/file-properties.png alt="file properties"></p><p>You can access the file using URI (read more about URIs in <a href=https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh965322.aspx>Microsoft&rsquo;s tutorial</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>async</span> Task&lt;<span style=color:#66d9ef>string</span>&gt; readSampleFile1()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> uri = <span style=color:#66d9ef>new</span> System.Uri(<span style=color:#e6db74>&#34;ms-appx:///sample.txt&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> sampleFile = <span style=color:#66d9ef>await</span> Windows.Storage.StorageFile.GetFileFromApplicationUriAsync(uri);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> Windows.Storage.FileIO.ReadTextAsync(sampleFile);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>or using the <code>StorageFolder</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>async</span> Task&lt;<span style=color:#66d9ef>string</span>&gt; readSampleFile2()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> packageFolder = Windows.ApplicationModel.Package.Current.InstalledLocation;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> sampleFile = <span style=color:#66d9ef>await</span> packageFolder.GetFileAsync(<span style=color:#e6db74>&#34;sample.txt&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> Windows.Storage.FileIO.ReadTextAsync(sampleFile);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>InstalledLocation</code> is a <code>StorageFolder</code>, and we can enumerate files contained within:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>async</span> Task enumerateFiles()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> packageFolder = Windows.ApplicationModel.Package.Current.InstalledLocation;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> files = <span style=color:#66d9ef>await</span> packageFolder.GetFilesAsync();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> file <span style=color:#66d9ef>in</span> files)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> path = file.Path;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Works only with text files:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// var contents = await Windows.Storage.FileIO.ReadTextAsync(file);</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=uwp-use-string-resources>UWP: Use string resources</h1><p>Windows offers powerful ways to access localized string resources. You can use the resources from both C# back-end and XAML front-end. The main benefit of this approach is that the resources come localized and customized to the user&rsquo;s device (images use the best size and contrast variants). You don&rsquo;t need to load, read and parse the file yourself. Furthermore, when a user changes their language preferences while your app is running, the strings in your app will be updated! These resources go to a <code>.resw</code> file, which appears to be a Windows 10 equivalent of <code>.resx</code> files.</p><p>Read the <a href=https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh965323.aspx>guide on loading string resources</a> and the
<a href=https://msdn.microsoft.com/en-us/library/windows/apps/xaml/hh965326.aspx>guide on creating localized resource files</a> to learn about all the features of this approach.</p><p>I just wanted to show how to use the most basic flavor of this approach, just to load the API token.</p><ol><li>Right click on the project, <code>Add > New Item</code>, pick <code>Resources File (.resw)</code>.</li><li>Save all, check the empty file into the source control and immediately ignore it (see &ldquo;Protect the API token&rdquo; section above)</li><li>Double click on the newly added file and add type in the API token.</li></ol><p><img src=//amadeusw.com/techBlogData//custom-resource-files-in-uwp-windows-10/resource-properties.png alt="resource file properties"></p><p>To access the token from the code, create an instance of <code>ResourceLoader</code>, passing in the name of the resource file <em>without the extension</em>.
Suppose you created <code>resourcesFile.resw</code> and added a line with the key <code>secret</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> resources = <span style=color:#66d9ef>new</span> Windows.ApplicationModel.Resources.ResourceLoader(<span style=color:#e6db74>&#34;resourcesFile&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> token = resources.GetString(<span style=color:#e6db74>&#34;secret&#34;</span>);
</span></span></code></pre></div><h1 id=error-handling>Error handling</h1><p>Suppose someone cloned your repo and wants to run your app. Whether you included an empty file in the repo, or ignored it without adding it, what will be their developer experience? Will your code fail gracefully, or crash the app?</p><ul><li><p>When the file doesn&rsquo;t exist:</p></li><li><p>Both <code>GetFileAsync</code> and <code>GetFileFromApplicationUriAsync</code> throw <code>FileNotFoundException</code> with message `The system cannot find the file</p></li><li><p><code>ResourceLoader</code> constructor throws <code>COMException</code> with message <code>ResourceMap Not Found.</code></p></li><li><p>When the file exists, but the resource can&rsquo;t be found</p></li><li><p>If you&rsquo;re parsing the file yourself, it&rsquo;s up to you to handle this scenario.</p></li><li><p><code>ResourceLoader.GetString</code> returns an empty string.</p></li></ul><h1 id=conclusion>Conclusion</h1><p>Whether you&rsquo;re using resources or reading files yourself, both options offer you a way to consume a file checked into the source control.
Using resources is slightly easier, as you don&rsquo;t need to open and parse the file.
Loading the file yourself, however, gives you far more flexibility if you need it.</p><p><strong>Which method will I use?</strong></p><p>Initially, I was sure I would load and parse a <code>.json</code> file. On top of storing API keys, I wanted to store a number of other parameters. A JSON array would be the perfect data structure for the job, unlike resources that I need to directly access by name.</p><p>I may feel inclined to try both approaches and store the JSON array as a string resource :)</p></article></main></div><div id=footer class=containerelement><div id=footerName><abbr title="Pronounce: A-ma-de-ows Vee-cho-reck">Amadeusz Wieczorek</abbr></div><div id=footerUnderName>I build productivity tools.</div><ul id=footerLinks><li><a href=//github.com/amadeusw>My github</a></li><li><a href=//amadeusw.com/portfolio>2013 portfolio</a></li><li><a href=feed.xml>RSS feed</a></li><li><a href=#>Scroll to top</a></li></div></div></div></body></html>