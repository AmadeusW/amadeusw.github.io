<!doctype html><html><head><title>Amadeus' page</title><link rel=stylesheet href=//amadeusw.com/css/style.css></head><body><div id=container class=centered><header id=title class="containerelement navcontent"><a class=link href=//amadeusw.com><span class=headercontent>Amadeo</span></a></header><div id=subtitle class="accent_dotnet containerelement navcontent"><span class=headercontent>Practical animations in XAML</span></div><nav class="accent_dotnet containerelement"><div class=navcontent><a class=link href=/travel/>Travel</a>
<a class=link href=/3dprinting/>3D printing</a>
<a class=link href=/tech/>Electronics</a>
<a class=link href=/projects/>Projects</a>
<a class=link href=/cookery/>Cookery</a>
<a class="link active" href=/dotnet/>.net</a></div></nav><div id=content class=containerelement><main class=centered><article class=dotnet><p>Let&rsquo;s build a sleek way to display notifications to the user. The messages won&rsquo;t show up in traditional pop-up windows, but instead slide in at the top of the screen. User can dismiss each one of them by clicking at it.</p><p><em>Complete project is available <a href=https://github.com/AmadeusW/MessagePanel>on GitHub</a> and this blog post covers only bits related to animation.</em></p><p>Each message animates twice: first, when it&rsquo;s added to the collection and first rendered, and second time, disappearing after user dismissed it.</p><p>Both animations are defined as <a href="http://msdn.microsoft.com/en-us/library/system.windows.frameworkelement.resources(v=vs.110).aspx">resources</a> of <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.itemscontrol(v=vs.110).aspx">ItemsControl</a>, and invoked by <a href="http://msdn.microsoft.com/en-us/library/system.windows.datatrigger(v=vs.110).aspx">DataTrigger</a> in <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.itemscontrol.itemcontainerstyle(v=vs.110).aspx">ItemsControl.ItemContainerStyle</a>. We are using ItemsControl element because it offers the most rendering flexibility.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;ItemsControl.Resources&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;Storyboard</span> <span style=color:#a6e22e>x:Key=</span><span style=color:#e6db74>&#34;enterStoryboard&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;ThicknessAnimation</span> <span style=color:#a6e22e>Storyboard.TargetProperty=</span><span style=color:#e6db74>&#34;Margin&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>Duration=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>From=</span><span style=color:#e6db74>&#34;0, 0, 500, 0&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>To=</span><span style=color:#e6db74>&#34;0, 0, 0, 0&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>DecelerationRatio=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>FillBehavior=</span><span style=color:#e6db74>&#34;HoldEnd&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;DoubleAnimation</span> <span style=color:#a6e22e>Storyboard.TargetProperty=</span><span style=color:#e6db74>&#34;Opacity&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>Duration=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>From=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>To=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>                                                   <span style=color:#a6e22e>FillBehavior=</span><span style=color:#e6db74>&#34;HoldEnd&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/Storyboard&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/ItemsControl.Resources&gt;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;ItemsControl.ItemContainerStyle&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;Style&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Style.Triggers&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;DataTrigger</span> <span style=color:#a6e22e>Binding=</span><span style=color:#e6db74>&#34;{Binding RelativeSource={x:Static RelativeSource.Self}, Path=DataContext.IsAlive}&#34;</span> <span style=color:#a6e22e>Value=</span><span style=color:#e6db74>&#34;True&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;StaticResource</span> <span style=color:#a6e22e>ResourceKey=</span><span style=color:#e6db74>&#34;enterStoryboard&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&lt;/BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/DataTrigger&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/Style.Triggers&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/Style&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/ItemsControl.ItemContainerStyle&gt;</span>
</span></span></code></pre></div><p>The DataTrigger fires the animation whenever property <code>IsAlive</code> is found to be <code>true</code>. Here, we instantiate it to <code>true</code> in each <code>MessageObject</code>.</p><p>Let&rsquo;s see how it looks like:</p><p>The slide-out effect for removed messages gets a bit more tricky. Once the element is removed from the collection, we can&rsquo;t animate it, because its graphical representation disappears.</p><p>We will use the property <code>IsAlive</code> to trigger the slide-out animation, and we will actually remove the message from the collection after the animation completes. Similarly to the enter animation, the exit animation is triggered by setting <code>isAlive</code> to <code>false</code>. This can be defined twofold in XAML:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- Simple approach, but may break if IsAlive is not initialized to true --&gt;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;DataTrigger</span> <span style=color:#a6e22e>Binding=</span><span style=color:#e6db74>&#34;{Binding RelativeSource={x:Static RelativeSource.Self}, Path=DataContext.IsAlive}&#34;</span> <span style=color:#a6e22e>Value=</span><span style=color:#e6db74>&#34;True&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;StaticResource</span> <span style=color:#a6e22e>ResourceKey=</span><span style=color:#e6db74>&#34;enterStoryboard&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;DataTrigger.ExitActions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;StaticResource</span> <span style=color:#a6e22e>ResourceKey=</span><span style=color:#e6db74>&#34;exitStoryboard&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/DataTrigger.ExitActions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/DataTrigger&gt;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- Another approach. In our case, it has the same result.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     It may be used to create more complex and robust triggers --&gt;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;DataTrigger</span> <span style=color:#a6e22e>Binding=</span><span style=color:#e6db74>&#34;{Binding RelativeSource={x:Static RelativeSource.Self}, Path=DataContext.IsAlive}&#34;</span> <span style=color:#a6e22e>Value=</span><span style=color:#e6db74>&#34;True&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;StaticResource</span> <span style=color:#a6e22e>ResourceKey=</span><span style=color:#e6db74>&#34;enterStoryboard&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/DataTrigger&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;DataTrigger</span> <span style=color:#a6e22e>Binding=</span><span style=color:#e6db74>&#34;{Binding RelativeSource={x:Static RelativeSource.Self}, Path=DataContext.IsAlive}&#34;</span> <span style=color:#a6e22e>Value=</span><span style=color:#e6db74>&#34;False&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;StaticResource</span> <span style=color:#a6e22e>ResourceKey=</span><span style=color:#e6db74>&#34;exitStoryboard&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/BeginStoryboard&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/DataTrigger.EnterActions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/DataTrigger&gt;</span>        
</span></span></code></pre></div><p>Ideally, we would listen to StoryboardCompleted event and remove the item once the framework tell us that the animation has completed. However, the StoryboardCompleted event doesn&rsquo;t have a reference to the removed item or the collection. How would we know which item to remove from the collection?</p><p>We need to wait agreed amount of time in the code-behind before the element can be removed from the collection. This is not an ideal solution, but I can&rsquo;t think of another way to achieve this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>void</span> RemoveMessage(<span style=color:#66d9ef>object</span> parameter)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> message = parameter <span style=color:#66d9ef>as</span> MessageObject;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (message != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Trigger the move-out animation</span>
</span></span><span style=display:flex><span>        message.IsAlive = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Remove the element after animation completes</span>
</span></span><span style=display:flex><span>        Task.Run(() =&gt;
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Thread.Sleep(<span style=color:#ae81ff>250</span>);
</span></span><span style=display:flex><span>                acutallyRemoveMessageFromCollection(message);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> acutallyRemoveMessageFromCollection(MessageObject message)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make sure this runs on the UI thread.</span>
</span></span><span style=display:flex><span>    Application.Current.Dispatcher.BeginInvoke
</span></span><span style=display:flex><span>        (System.Windows.Threading.DispatcherPriority.Normal,
</span></span><span style=display:flex><span>        (Action)(() =&gt;
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Messages.Remove(message);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here&rsquo;s how it looks like:</p><p>We can see the item occupies its space as it animates out, and other items abruptly jump in its space after the item is removed.
We can address that by adding a slide-up animation to the <code>exitStoryboard</code>. The second animation starts only when the first animation ends (note the <code>BeginTime</code>). The animation changes the top margin of the item to -50, effectively dragging it up. We&rsquo;re happy to see that all items below it also move up!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;Storyboard</span> <span style=color:#a6e22e>x:Key=</span><span style=color:#e6db74>&#34;exitStoryboard&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ThicknessAnimation</span> <span style=color:#a6e22e>Storyboard.TargetProperty=</span><span style=color:#e6db74>&#34;Margin&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>Duration=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>From=</span><span style=color:#e6db74>&#34;0, 0, 0, 0&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>To=</span><span style=color:#e6db74>&#34;500, 0, 0, 0&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>AccelerationRatio=</span><span style=color:#e6db74>&#34;1&#34;</span>                                        
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>FillBehavior=</span><span style=color:#e6db74>&#34;HoldEnd&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;DoubleAnimation</span> <span style=color:#a6e22e>Storyboard.TargetProperty=</span><span style=color:#e6db74>&#34;Opacity&#34;</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#a6e22e>Duration=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#a6e22e>From=</span><span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#a6e22e>To=</span><span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#a6e22e>FillBehavior=</span><span style=color:#e6db74>&#34;HoldEnd&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!-- After sliding out to the right, slide up so that remaining items 
</span></span></span><span style=display:flex><span><span style=color:#75715e>         in the collection smoothly fill the gap --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ThicknessAnimation</span> <span style=color:#a6e22e>Storyboard.TargetProperty=</span><span style=color:#e6db74>&#34;Margin&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>BeginTime=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>Duration=</span><span style=color:#e6db74>&#34;00:00:00.25&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>From=</span><span style=color:#e6db74>&#34;500, 0, 0, 0&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>To=</span><span style=color:#e6db74>&#34;500, -50, 0, 0&#34;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>DecelerationRatio=</span><span style=color:#e6db74>&#34;1&#34;</span>                                        
</span></span><span style=display:flex><span>                                                     <span style=color:#a6e22e>FillBehavior=</span><span style=color:#e6db74>&#34;HoldEnd&#34;</span> <span style=color:#f92672>/&gt;</span>                
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Storyboard&gt;</span>
</span></span></code></pre></div><p>Now we only need to change the code-behind to wait for both animations to finish before removing the element, so we change the delay from 250ms to 500ms. That&rsquo;s the final effect:</p><p>For best results, this control can be placed above the rest of your app with help of <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.panel.zindex(v=vs.110).aspx">Z-index</a></p><ul><li><a href=https://github.com/AmadeusW/MessagePanel>Browse &ldquo;animating the collection&rdquo; source on GitHub</a>.</li></ul></article></main></div><div id=footer class=containerelement><div id=footerName><abbr title="Pronounce: A-ma-de-ows Vee-cho-reck">Amadeus Wieczorek</abbr></div><div id=footerUnderName>I supercharge your productivity.</div><ul id=footerLinks><li><a href=//github.com/amadeusw>My github</a></li><li><a href=//amadeusw.com/portfolio>2013 portfolio</a></li><li><a href=feed.xml>RSS feed</a></li><li><a href=#>Scroll to top</a></li></div></div></div></body></html>